<script>
const $ = (id)=>document.getElementById(id);

const STORAGE = {
  used: "ipa_ca_used_v1",
  pool: "ipa_ca_pool_v1",
  cont: "ipa_ca_cont_v1",
};

const STATE = {
  currentWord: null,
  solution: null,
  pool: [],
  used: new Set(),
  contByCat: {},
  onlineOk: true,
  lastSource: "",
};

const CATEGORIES = [
  "Categoria:Mots_en_catal%C3%A0_d%271_s%C3%ADl%C2%B7laba",
  "Categoria:Mots_en_catal%C3%A0_de_2_s%C3%ADl%C2%B7labes",
  "Categoria:Mots_en_catal%C3%A0_de_3_s%C3%ADl%C2%B7labes",
  "Categoria:Mots_en_catal%C3%A0_de_4_s%C3%ADl%C2%B7labes",
];

const OFFLINE_WORDS = [
  "casa","cotxe","noia","noi","poma","llibre","finestra","taula","cadira","escola",
  "vent","pluja","fred","calor","llengua","català","balena","peix","carrer","plaça",
  "família","amiga","amic","diumenge","dilluns","estudi","examen","paraula","lletra",
  "cotó","cafè","aigua","foc","terra","mar","muntanya","ciutat","barri","mercat",
  "públic","privat","història","filosofia","ciència","música","teatre","pel·lícula",
  "intel·ligència","encobreixen","treball","recerca","dialecte","fonètica","síl·laba",
  "consonant","vocal","sonor","sord","africada","fricativa","nasal","lateral","vibrant"
];

function saveState(){
  localStorage.setItem(STORAGE.used, JSON.stringify([...STATE.used]));
  localStorage.setItem(STORAGE.pool, JSON.stringify(STATE.pool));
  localStorage.setItem(STORAGE.cont, JSON.stringify(STATE.contByCat));
}
function loadState(){
  try{ STATE.used = new Set(JSON.parse(localStorage.getItem(STORAGE.used) || "[]")); } catch { STATE.used = new Set(); }
  try{ const p = JSON.parse(localStorage.getItem(STORAGE.pool) || "[]"); STATE.pool = Array.isArray(p) ? p : []; } catch { STATE.pool = []; }
  try{ const c = JSON.parse(localStorage.getItem(STORAGE.cont) || "{}"); STATE.contByCat = (c && typeof c === "object") ? c : {}; } catch { STATE.contByCat = {}; }
}

function looksLikeCatalanWord(t){
  if(!t) return false;
  if(t.includes(":")) return false;
  if(t.includes("(") || t.includes(")")) return false;
  if(t.includes(",")) return false;
  if(t.trim() !== t) return false;
  if(t.length < 2 || t.length > 26) return false;
  if(t.includes(" ")) return false;
  return /^[A-Za-zÀ-ÖØ-öø-ÿ·'’-]+$/.test(t);
}

function normalizeIPA(s){
  if(!s) return "";
  let x = s.trim().normalize("NFC");
  x = x.replaceAll(":", "ː");
  x = x.replaceAll("ɡ", "g");
  x = x.replaceAll("’", "'");
  x = x.replace(/\s+/g, " ");
  x = x.replace(/^\[|\]$/g, "");
  return x;
}

function segmentIPA(s){
  const str = normalizeIPA(s);
  const out = [];
  for (const ch of str){
    if(/\p{M}/u.test(ch)){
      if(out.length) out[out.length-1] += ch;
      else out.push(ch);
    } else out.push(ch);
  }
  return out;
}

function simpleDiff(a,b){
  const A = segmentIPA(a);
  const B = segmentIPA(b);
  const dp = Array(A.length+1).fill(0).map(()=>Array(B.length+1).fill(0));
  for(let i=1;i<=A.length;i++){
    for(let j=1;j<=B.length;j++){
      dp[i][j] = (A[i-1]===B[j-1]) ? dp[i-1][j-1]+1 : Math.max(dp[i-1][j], dp[i][j-1]);
    }
  }
  let i=A.length, j=B.length;
  const missing=[], extra=[];
  while(i>0 || j>0){
    if(i>0 && j>0 && A[i-1]===B[j-1]){ i--; j--; }
    else if(j>0 && (i===0 || dp[i][j-1]>=dp[i-1][j])){ extra.push(B[j-1]); j--; }
    else { missing.push(A[i-1]); i--; }
  }
  return { missing: missing.reverse().join(""), extra: extra.reverse().join("") };
}

async function mwFetch(apiBase, params){
  // GitHub Pages → fetch CORS amb origin=*
  params.origin = "*";
  params.format = "json";
  const url = apiBase + "?" + new URLSearchParams(params).toString();
  const r = await fetch(url, { method: "GET" });
  if(!r.ok){
    const body = await r.text().catch(()=> "");
    throw new Error(`HTTP ${r.status}: ${body || r.statusText}`);
  }
  return r.json();
}

async function fetchMoreWords(){
  const cat = CATEGORIES[Math.floor(Math.random()*CATEGORIES.length)];
  const cont = STATE.contByCat[cat] || null;

  const data = await mwFetch("https://ca.wiktionary.org/w/api.php", {
    action: "query",
    list: "categorymembers",
    cmtitle: cat,
    cmnamespace: "0",
    cmlimit: "200",
    ...(cont ? { cmcontinue: cont } : {})
  });

  const cm = data?.query?.categorymembers || [];
  const next = data?.continue?.cmcontinue || null;
  if(next) STATE.contByCat[cat] = next;
  else delete STATE.contByCat[cat];

  let added = 0;
  for(const it of cm){
    const t = it?.title;
    if(!looksLikeCatalanWord(t)) continue;
    if(STATE.used.has(t)) continue;
    if(STATE.pool.includes(t)) continue;
    STATE.pool.push(t);
    added++;
  }
  saveState();
  updatePills();
}

async function fetchIPA(word){
  const text = `{{ca-IPA|${word}}}`;
  const data = await mwFetch("https://en.wiktionary.org/w/api.php", {
    action: "parse",
    contentmodel: "wikitext",
    prop: "text",
    text
  });

  const html = data?.parse?.text?.["*"];
  if(!html) throw new Error("No s'ha pogut generar HTML IPA");

  const box = document.createElement("div");
  box.innerHTML = html;
  const ipaSpans = [...box.querySelectorAll(".IPA")];
  if(ipaSpans.length === 0) throw new Error("No s'ha trobat IPA a la resposta");

  let central = null, valencian = null;
  for(const sp of ipaSpans){
    const ipa = sp.textContent.trim();
    const ctx = (sp.parentElement?.textContent || "").toLowerCase();
    if(ctx.includes("valencia")) valencian = ipa;
    else if(!central) central = ipa;
  }

  return { central, valencian, rawHtml: html, source: "Wiktionary (Template:ca-IPA)" };
}

function updatePills(){
  $("pillPool").textContent = "Pool: " + STATE.pool.length;
  $("pillUsed").textContent = "Usades: " + STATE.used.size;
  $("pillMode").textContent = "Mode: " + (STATE.onlineOk ? "Online" : "Offline");
}

function showFeedback(kind, title, bodyHtml){
  const el = $("feedback");
  el.className = "msg " + kind;
  el.style.display = "block";
  el.innerHTML = `<div class="t">${title}</div><div class="b">${bodyHtml}</div>`;
}
function clearFeedback(){
  $("feedback").style.display = "none";
  $("feedback").className = "msg";
  $("feedback").innerHTML = "";
}

function setWord(w){
  STATE.currentWord = w;
  $("word").textContent = w;
  $("ipa").value = "";
  $("ipa").focus();
  clearFeedback();
  $("sourceLine").textContent = "";
}

function getTargetDialect(){ return $("dialect").value; }

function formatSolution(sol){
  const c = sol?.central ? `[${sol.central}]` : "—";
  const v = sol?.valencian ? `[${sol.valencian}]` : "—";
  return { c, v };
}

function expectedForDialect(sol, dialect){
  if(!sol) return null;
  if(dialect === "valencian") return sol.valencian || sol.central;
  return sol.central;
}

function buildHints(user, exp){
  const hints = [];
  const u = normalizeIPA(user);
  const e = normalizeIPA(exp);

  const userHasStress = /[ˈˌ]/.test(u);
  const expHasStress  = /[ˈˌ]/.test(e);
  if(expHasStress && !userHasStress) hints.push("T’has deixat la marca d’accent (<span class='monoIPA'>ˈ</span>/<span class='monoIPA'>ˌ</span>).");

  if(e.includes("ə") && !u.includes("ə")) hints.push("Falta <span class='monoIPA'>ə</span> (vocal neutra) — habitual en àtones (central/balear).");
  if(u.includes("ə") && !e.includes("ə")) hints.push("Has posat <span class='monoIPA'>ə</span> però la solució esperada no en porta (pot ser vocal/dialecte).");

  if(e.includes("ɾ") && !u.includes("ɾ") && u.includes("r")) hints.push("Atenció <span class='monoIPA'>ɾ</span> (simple) vs <span class='monoIPA'>r</span> (múltiple).");
  if(e.includes("ʎ") && !u.includes("ʎ")) hints.push("Falta <span class='monoIPA'>ʎ</span> (ll).");
  if(e.includes("ɲ") && !u.includes("ɲ")) hints.push("Falta <span class='monoIPA'>ɲ</span> (ny).");

  const d = simpleDiff(e,u);
  if(d.missing || d.extra){
    if(d.missing) hints.push(`Falten: <span class="monoIPA">"${d.missing}"</span>`);
    if(d.extra) hints.push(`Sobra: <span class="monoIPA">"${d.extra}"</span>`);
  }
  return [...new Set(hints)].slice(0,6);
}

async function ensureWord(){
  if(STATE.pool.length < 20 && STATE.onlineOk){
    try{ await fetchMoreWords(); } catch { STATE.onlineOk = false; updatePills(); }
  }
  if(STATE.pool.length === 0){
    for(const w of OFFLINE_WORDS) if(!STATE.used.has(w)) STATE.pool.push(w);
    STATE.onlineOk = false;
    updatePills();
  }

  const idx = Math.floor(Math.random()*STATE.pool.length);
  const w = STATE.pool.splice(idx,1)[0];
  STATE.used.add(w);
  saveState();
  updatePills();
  setWord(w);

  STATE.solution = null;
  $("sourceLine").textContent = "";
  if(STATE.onlineOk){
    try{
      STATE.solution = await fetchIPA(w);
      $("sourceLine").textContent = "Solució: " + STATE.solution.source;
    }catch(e){
      showFeedback("warn","No he pogut generar la solució IPA (online)",
        "Error obtenint la solució. Prova <b>Nova paraula</b>." +
        `<div class='smallNote' style='margin-top:6px'>Detall: ${e?.message || e}</div>`
      );
    }
  }else{
    showFeedback("warn","Mode offline (limitacions)","Sense connexió: paraules i solució limitades.");
  }
}

async function newWord(){ await ensureWord(); }

function reveal(){
  if(!STATE.solution){
    showFeedback("warn","Encara no hi ha solució","Prova <b>Nova paraula</b>.");
    return;
  }
  const {c,v} = formatSolution(STATE.solution);
  showFeedback("warn","Solució",
    `<div><b>Central/Balear:</b> <span class="monoIPA">${c}</span></div>` +
    `<div style="margin-top:6px"><b>Valencià:</b> <span class="monoIPA">${v}</span></div>`
  );
}

function check(){
  if(!STATE.currentWord){ showFeedback("warn","No hi ha paraula","Clica <b>Nova paraula</b>."); return; }
  if(!STATE.solution){ showFeedback("warn","No hi ha solució","Prova <b>Nova paraula</b>."); return; }

  const dialect = getTargetDialect();
  const user = $("ipa").value;

  const expCentral = STATE.solution.central || "";
  const expVal = STATE.solution.valencian || "";
  const expTarget = expectedForDialect(STATE.solution, dialect) || "";

  const nu = normalizeIPA(user);
  const neT = normalizeIPA(expTarget);

  if(nu === neT){
    showFeedback("ok","Correcte ✅", `Molt bé! <span class="monoIPA">[${nu}]</span>`);
    return;
  }

  if(dialect === "both"){
    const neC = normalizeIPA(expCentral || "");
    const neV = normalizeIPA(expVal || "");
    if(nu === neC || (neV && nu === neV)){
      showFeedback("ok","Correcte ✅", `Coincideix amb una variant: <span class="monoIPA">[${nu}]</span>`);
      return;
    }
  }

  const {c,v} = formatSolution(STATE.solution);
  const hints = buildHints(user, expTarget);
  const hintHtml = hints.length ? `<ul class="hintList">${hints.map(h=>`<li>${h}</li>`).join("")}</ul>` : "";

  showFeedback("bad","No és exactament igual ❌",
    `<div><b>La teva:</b> <span class="monoIPA">[${normalizeIPA(user)}]</span></div>` +
    `<div style="margin-top:6px"><b>Solució (Central/Balear):</b> <span class="monoIPA">${c}</span></div>` +
    `<div style="margin-top:6px"><b>Solució (Valencià):</b> <span class="monoIPA">${v}</span></div>` +
    (hintHtml ? `<div style="margin-top:10px"><b>Pistes:</b>${hintHtml}</div>` : "")
  );
}

function resetPool(){
  STATE.used = new Set();
  STATE.pool = [];
  STATE.contByCat = {};
  saveState();
  updatePills();
  showFeedback("warn","Pool reiniciat","He esborrat l’historial de paraules usades.");
}

/** Teclat (igual que tenies) */
const IPA_KEYS = [
  {k:"[", t:"["},{k:"]", t:"]"},{k:".", t:"."},{k:"ˈ", t:"ˈ"},{k:"ˌ", t:"ˌ"},{k:"ː", t:"ː"},
  {k:"‿", t:"‿", small:true},
  {k:"i",t:"i"},{k:"e",t:"e"},{k:"ɛ",t:"ɛ"},{k:"a",t:"a"},{k:"ə",t:"ə"},{k:"ɔ",t:"ɔ"},{k:"o",t:"o"},{k:"u",t:"u"},{k:"y",t:"y"},{k:"ø",t:"ø"},
  {k:"p",t:"p"},{k:"b",t:"b"},{k:"t",t:"t"},{k:"d",t:"d"},{k:"k",t:"k"},{k:"g",t:"g"},
  {k:"β",t:"β"},{k:"ð",t:"ð"},{k:"ɣ",t:"ɣ"},
  {k:"f",t:"f"},{k:"v",t:"v"},{k:"s",t:"s"},{k:"z",t:"z"},{k:"ʃ",t:"ʃ"},{k:"ʒ",t:"ʒ"},
  {k:"x",t:"x"},{k:"ɲ",t:"ɲ"},{k:"ŋ",t:"ŋ"},{k:"ɱ",t:"ɱ"},{k:"m",t:"m"},{k:"n",t:"n"},
  {k:"l",t:"l"},{k:"ʎ",t:"ʎ"},{k:"ɫ",t:"ɫ", small:true},{k:"ɾ",t:"ɾ"},{k:"r",t:"r"},
  {k:"j",t:"j"},{k:"w",t:"w"},
  {k:"t͡s",t:"t͡s", small:true},{k:"d͡z",t:"d͡z", small:true},{k:"t͡ʃ",t:"t͡ʃ", small:true},{k:"d͡ʒ",t:"d͡ʒ", small:true},
  {k:"ʔ",t:"ʔ", small:true},{k:"ʲ",t:"ʲ", small:true},{k:"̃",t:"̃", small:true},
];

function insertAtCursor(input, text){
  const start = input.selectionStart ?? input.value.length;
  const end = input.selectionEnd ?? input.value.length;
  input.value = input.value.slice(0,start) + text + input.value.slice(end);
  const pos = start + text.length;
  input.setSelectionRange(pos,pos);
  input.focus();
}

function buildKeyboard(){
  const host = $("kbd");
  host.innerHTML = "";
  for(const it of IPA_KEYS){
    const d = document.createElement("div");
    d.className = "key monoIPA" + (it.small ? " small" : "");
    d.textContent = it.k;
    d.addEventListener("click", ()=> insertAtCursor($("ipa"), it.t));
    host.appendChild(d);
  }
}

function wire(){
  $("btnNew").addEventListener("click", newWord);
  $("btnReset").addEventListener("click", resetPool);
  $("btnCheck").addEventListener("click", check);
  $("btnReveal").addEventListener("click", reveal);
  $("btnClear").addEventListener("click", ()=>{ $("ipa").value=""; $("ipa").focus(); });

  $("btnBksp").addEventListener("click", ()=>{
    const inp = $("ipa");
    const start = inp.selectionStart ?? inp.value.length;
    const end = inp.selectionEnd ?? inp.value.length;
    if(start !== end){
      inp.value = inp.value.slice(0,start) + inp.value.slice(end);
      inp.setSelectionRange(start,start);
    } else if(start>0){
      inp.value = inp.value.slice(0,start-1) + inp.value.slice(start);
      inp.setSelectionRange(start-1,start-1);
    }
    inp.focus();
  });

  $("btnSpace").addEventListener("click", ()=> insertAtCursor($("ipa"), " "));

  $("ipa").addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){ e.preventDefault(); check(); }
  });
}

(function init(){
  loadState();
  buildKeyboard();
  wire();
  updatePills();
  newWord();
})();
</script>
