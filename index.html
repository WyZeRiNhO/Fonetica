<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pràctica de fonètica (IPA català)</title>

  <!-- Fonts IPA (si tens Internet). Si no, farà fallback a fonts del sistema -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+IPA:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;
      --text:#e9eefc;
      --muted:#a9b4d6;
      --ok:#2ee59d;
      --bad:#ff5a7a;
      --warn:#ffcc66;
      --btn:#1c2b52;
      --btn2:#253a6d;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --radius: 18px;
      --ipa: "Noto Sans IPA","Doulos SIL","Charis SIL","DejaVu Sans","Arial Unicode MS",system-ui,sans-serif;
      --ui: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1000px 600px at 20% 0%, #15224a 0%, var(--bg) 45%, #070c16 100%);
      color:var(--text);
      font-family: var(--ui);
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:26px 18px 40px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    .title{display:flex;flex-direction:column;gap:6px}
    .title h1{margin:0;font-size:22px;letter-spacing:.2px}
    .title p{margin:0;color:var(--muted);font-size:13px}
    .author{
      font-family:var(--ui);color:var(--muted);font-size:13px;padding:10px 12px;
      background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
      border-radius:999px;box-shadow: 0 10px 30px rgba(0,0,0,.25);white-space:nowrap;
    }
    .grid{display:grid;grid-template-columns: 1.1fr .9fr;gap:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .card .hd .left{display:flex;flex-direction:column;gap:4px}
    .card .hd .ttl{font-weight:700;letter-spacing:.2px}
    .card .hd .sub{color:var(--muted);font-size:12px}
    .card .bd{padding:16px}

    .bigWord{
      background: rgba(255,255,255,.03);
      border:1px dashed rgba(255,255,255,.18);
      border-radius: 16px;
      padding:16px;
      display:flex;align-items:center;justify-content:center;
      min-height:110px;
    }
    .bigWord .w{
      font-size:46px;font-weight:800;letter-spacing:.6px;
      text-align:center;line-height:1.05;word-break:break-word;
    }

    .controls{display:grid;grid-template-columns: 1.2fr .8fr .8fr;gap:10px;margin-top:12px}
    @media (max-width: 520px){.controls{grid-template-columns:1fr}}

    select, button, input{
      font-family: var(--ui);
      color:var(--text);
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding:10px 12px;
      outline:none;
    }
    input:focus, select:focus{
      border-color: rgba(120,170,255,.65);
      box-shadow: 0 0 0 3px rgba(120,170,255,.18);
    }
    button{
      cursor:pointer;
      background: linear-gradient(180deg, var(--btn2), var(--btn));
      border:1px solid rgba(255,255,255,.12);
      font-weight:700;
      letter-spacing:.15px;
      transition:.15s transform ease, .15s filter ease;
    }
    button:hover{filter:brightness(1.08)}
    button:active{transform: translateY(1px)}
    .btnGhost{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      font-weight:600;
    }

    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .rightTop{display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap}

    .monoIPA{font-family: var(--ipa);font-variant-ligatures: normal;font-feature-settings: "liga" 1, "clig" 1}
    .ipaInput{
      width:100%;
      font-family: var(--ipa);
      font-size:22px;
      padding:12px 14px;
      background: rgba(0,0,0,.25);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex: 1 1 auto}

    .sep{height:1px;background:rgba(255,255,255,.08);margin:14px 0}

    .msg{
      margin-top:12px;padding:12px 12px;border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
    }
    .msg.ok{border-color: rgba(46,229,157,.45); background: rgba(46,229,157,.08)}
    .msg.bad{border-color: rgba(255,90,122,.45); background: rgba(255,90,122,.08)}
    .msg.warn{border-color: rgba(255,204,102,.45); background: rgba(255,204,102,.08)}
    .msg .t{font-weight:800;margin-bottom:6px}
    .msg .b{color:var(--muted);line-height:1.45}

    .smallNote{color:var(--muted);font-size:12px;line-height:1.35}
    .sourceLine{margin-top:8px;color:var(--muted);font-size:12px}
    .hintList{margin:8px 0 0; padding-left:18px; color:var(--muted)}
    .hintList li{margin:4px 0}

    .kbd{display:grid;grid-template-columns: repeat(10, minmax(0,1fr));gap:8px}
    @media (max-width: 980px){.kbd{grid-template-columns: repeat(8, minmax(0,1fr));}}
    @media (max-width: 520px){.kbd{grid-template-columns: repeat(6, minmax(0,1fr));}}

    .key{
      user-select:none;text-align:center;padding:10px 6px;
      border-radius: 12px;border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-family: var(--ipa);font-size:18px;
      cursor:pointer;transition:.12s transform ease, .12s filter ease;
    }
    .key:hover{filter:brightness(1.15)}
    .key:active{transform: translateY(1px)}
    .key.small{font-size:14px}

    .twoCol{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    @media (max-width: 520px){.twoCol{grid-template-columns:1fr}}

    .tag{
      display:inline-block;font-size:12px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--muted);
    }
    .kbdTitle{display:flex;align-items:center;justify-content:space-between;gap:12px}

    .footer{
      margin-top:14px;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      color:var(--muted);font-size:12px
    }
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Pràctica de fonètica — Transcripció IPA (català)</h1>
        <p>Paraules reals del Viccionari + solució IPA automàtica (Wiktionary ca-IPA). Sense servidor, GitHub Pages friendly.</p>
      </div>
      <div class="author">Autor: <b>WyZeR</b></div>
    </header>

    <div class="grid">
      <!-- ESQUERRA -->
      <section class="card">
        <div class="hd">
          <div class="left">
            <div class="ttl">La paraula a transcriure</div>
            <div class="sub">Escriu la transcripció i clica <b>Corregir</b>. Pots inserir símbols amb el teclat IPA.</div>
          </div>
          <div class="rightTop">
            <span class="pill" id="pillMode">Mode: —</span>
            <span class="pill" id="pillPool">Pool: —</span>
            <span class="pill" id="pillUsed">Usades: —</span>
          </div>
        </div>

        <div class="bd">
          <div class="bigWord"><div class="w" id="word">—</div></div>

          <div class="controls" style="margin-top:14px">
            <select id="dialect">
              <option value="central">Dialecte objectiu: Central/Balear (oriental)</option>
              <option value="valencian">Dialecte objectiu: Valencià</option>
              <option value="both">Mostra tots (Central/Balear + Valencià)</option>
            </select>

            <button id="btnNew">Nova paraula</button>
            <button id="btnReset" class="btnGhost" title="Reinicia pool = torna a permetre repeticions i buida l'historial de paraules usades.">
              Reinicia pool
            </button>
          </div>

          <div class="sep"></div>

          <label class="smallNote">Transcripció (IPA):</label>
          <input id="ipa" class="ipaInput monoIPA" autocomplete="off" spellcheck="false" placeholder="Ex: [kəˈtaː]" />

          <div class="row" style="margin-top:10px">
            <button id="btnCheck">Corregir</button>
            <button id="btnReveal" class="btnGhost">Mostra solució</button>
            <button id="btnClear" class="btnGhost">Neteja</button>
          </div>

          <div id="feedback" class="msg" style="display:none"></div>
          <div class="sourceLine" id="sourceLine"></div>

          <div class="sep"></div>

          <div class="smallNote">
            <b>Online:</b> consulta Viccionari (paraules) i Wiktionary ca-IPA (solució). Si falla Internet, entra en mode offline.
          </div>

          <div class="footer">
            <div>Versió: <span id="ver">v2-pages-fix</span></div>
            <div>Truc: obre amb <code>?v=2</code> si tens caché</div>
          </div>
        </div>
      </section>

      <!-- DRETA -->
      <aside class="card">
        <div class="hd">
          <div class="left">
            <div class="ttl kbdTitle">
              <span>Teclat IPA català</span>
              <span class="tag monoIPA">ɱ inclosa</span>
            </div>
            <div class="sub">Clica un símbol per inserir-lo. (Normalitzem per evitar errors de fonts)</div>
          </div>
        </div>
        <div class="bd">
          <div class="kbd" id="kbd"></div>

          <div class="sep"></div>

          <div class="twoCol">
            <button class="btnGhost" id="btnBksp">⌫ Esborrar</button>
            <button class="btnGhost" id="btnSpace">Espai</button>
          </div>

          <div class="sep"></div>

          <div class="smallNote">
            <b>Ela geminada (l·l):</b> sovint <span class="monoIPA">[lː]</span> o <span class="monoIPA">[l.l]</span>, segons criteri.
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
/* ========== PROTECCIÓ ANTI-PÀGINA EN BLANC ========== */
window.addEventListener("error", (e)=>{
  document.body.innerHTML =
    "<pre style='color:white;padding:20px;background:#111;white-space:pre-wrap'>" +
    "ERROR JS: " + (e.message || e.error) + "</pre>";
});
window.addEventListener("unhandledrejection", (e)=>{
  document.body.innerHTML =
    "<pre style='color:white;padding:20px;background:#111;white-space:pre-wrap'>" +
    "PROMESA FALLADA: " + (e.reason?.message || e.reason) + "</pre>";
});

/* ====================== APP ====================== */
const $ = (id)=>document.getElementById(id);

const STORAGE = {
  used: "ipa_ca_used_v1",
  pool: "ipa_ca_pool_v1",
  cont: "ipa_ca_cont_v1",
};

const STATE = {
  currentWord: null,
  solution: null,
  pool: [],
  used: new Set(),
  contByCat: {},
  onlineOk: true,
};

const CATEGORIES = [
  "Categoria:Mots_en_catal%C3%A0_d%271_s%C3%ADl%C2%B7laba",
  "Categoria:Mots_en_catal%C3%A0_de_2_s%C3%ADl%C2%B7labes",
  "Categoria:Mots_en_catal%C3%A0_de_3_s%C3%ADl%C2%B7labes",
  "Categoria:Mots_en_catal%C3%A0_de_4_s%C3%ADl%C2%B7labes",
];

const OFFLINE_WORDS = [
  "casa","cotxe","noia","noi","poma","llibre","finestra","taula","cadira","escola",
  "vent","pluja","fred","calor","llengua","català","balena","peix","carrer","plaça",
  "família","amiga","amic","diumenge","dilluns","estudi","examen","paraula","lletra",
  "cotó","cafè","aigua","foc","terra","mar","muntanya","ciutat","barri","mercat",
  "públic","privat","història","filosofia","ciència","música","teatre","pel·lícula",
  "intel·ligència","encobreixen","treball","recerca","dialecte","fonètica","síl·laba",
  "consonant","vocal","sonor","sord","africada","fricativa","nasal","lateral","vibrant"
];

function saveState(){
  localStorage.setItem(STORAGE.used, JSON.stringify([...STATE.used]));
  localStorage.setItem(STORAGE.pool, JSON.stringify(STATE.pool));
  localStorage.setItem(STORAGE.cont, JSON.stringify(STATE.contByCat));
}
function loadState(){
  try{ STATE.used = new Set(JSON.parse(localStorage.getItem(STORAGE.used) || "[]")); } catch { STATE.used = new Set(); }
  try{ const p = JSON.parse(localStorage.getItem(STORAGE.pool) || "[]"); STATE.pool = Array.isArray(p) ? p : []; } catch { STATE.pool = []; }
  try{ const c = JSON.parse(localStorage.getItem(STORAGE.cont) || "{}"); STATE.contByCat = (c && typeof c === "object") ? c : {}; } catch { STATE.contByCat = {}; }
}

function looksLikeCatalanWord(t){
  if(!t) return false;
  if(t.includes(":")) return false;
  if(t.includes("(") || t.includes(")")) return false;
  if(t.includes(",")) return false;
  if(t.trim() !== t) return false;
  if(t.length < 2 || t.length > 26) return false;
  if(t.includes(" ")) return false;
  return /^[A-Za-zÀ-ÖØ-öø-ÿ·'’-]+$/.test(t);
}

function normalizeIPA(s){
  if(!s) return "";
  let x = s.trim().normalize("NFC");
  x = x.replaceAll(":", "ː");
  x = x.replaceAll("ɡ", "g");
  x = x.replaceAll("’", "'");
  x = x.replace(/\s+/g, " ");
  x = x.replace(/^\[|\]$/g, "");
  return x;
}

/* Evitem /\p{M}/u per compatibilitat: usem rang U+0300..U+036F */
function segmentIPA(s){
  const str = normalizeIPA(s);
  const out = [];
  for (let i=0;i<str.length;i++){
    const code = str.charCodeAt(i);
    const ch = str[i];
    if (code >= 0x0300 && code <= 0x036F){
      if(out.length) out[out.length-1] += ch;
      else out.push(ch);
    } else out.push(ch);
  }
  return out;
}

function simpleDiff(a,b){
  const A = segmentIPA(a);
  const B = segmentIPA(b);
  const dp = Array(A.length+1).fill(0).map(()=>Array(B.length+1).fill(0));
  for(let i=1;i<=A.length;i++){
    for(let j=1;j<=B.length;j++){
      dp[i][j] = (A[i-1]===B[j-1]) ? dp[i-1][j-1]+1 : Math.max(dp[i-1][j], dp[i][j-1]);
    }
  }
  let i=A.length, j=B.length;
  const missing=[], extra=[];
  while(i>0 || j>0){
    if(i>0 && j>0 && A[i-1]===B[j-1]){ i--; j--; }
    else if(j>0 && (i===0 || dp[i][j-1]>=dp[i-1][j])){ extra.push(B[j-1]); j--; }
    else { missing.push(A[i-1]); i--; }
  }
  return { missing: missing.reverse().join(""), extra: extra.reverse().join("") };
}

async function mwFetch(apiBase, params){
  params.origin = "*";
  params.format = "json";
  const url = apiBase + "?" + new URLSearchParams(params).toString();
  const r = await fetch(url, { method: "GET" });
  if(!r.ok){
    const body = await r.text().catch(()=> "");
    throw new Error(`HTTP ${r.status}: ${body || r.statusText}`);
  }
  return r.json();
}

async function fetchMoreWords(){
  const cat = CATEGORIES[Math.floor(Math.random()*CATEGORIES.length)];
  const cont = STATE.contByCat[cat] || null;

  const data = await mwFetch("https://ca.wiktionary.org/w/api.php", {
    action: "query",
    list: "categorymembers",
    cmtitle: cat,
    cmnamespace: "0",
    cmlimit: "200",
    ...(cont ? { cmcontinue: cont } : {})
  });

  const cm = data?.query?.categorymembers || [];
  const next = data?.continue?.cmcontinue || null;
  if(next) STATE.contByCat[cat] = next;
  else delete STATE.contByCat[cat];

  for(const it of cm){
    const t = it?.title;
    if(!looksLikeCatalanWord(t)) continue;
    if(STATE.used.has(t)) continue;
    if(STATE.pool.includes(t)) continue;
    STATE.pool.push(t);
  }
  saveState();
  updatePills();
}

async function fetchIPA(word){
  const text = `{{ca-IPA|${word}}}`;
  const data = await mwFetch("https://en.wiktionary.org/w/api.php", {
    action: "parse",
    contentmodel: "wikitext",
    prop: "text",
    text
  });

  const html = data?.parse?.text?.["*"];
  if(!html) throw new Error("No s'ha pogut generar HTML IPA");

  const box = document.createElement("div");
  box.innerHTML = html;

  const ipaSpans = [...box.querySelectorAll(".IPA")];
  if(ipaSpans.length === 0) throw new Error("No s'ha trobat IPA a la resposta");

  let central = null, valencian = null;
  for(const sp of ipaSpans){
    const ipa = sp.textContent.trim();
    const ctx = (sp.parentElement?.textContent || "").toLowerCase();
    if(ctx.includes("valencia")) valencian = ipa;
    else if(!central) central = ipa;
  }

  return { central, valencian, source: "Wiktionary (Template:ca-IPA)" };
}

function updatePills(){
  $("pillPool").textContent = "Pool: " + STATE.pool.length;
  $("pillUsed").textContent = "Usades: " + STATE.used.size;
  $("pillMode").textContent = "Mode: " + (STATE.onlineOk ? "Online" : "Offline");
}

function showFeedback(kind, title, bodyHtml){
  const el = $("feedback");
  el.className = "msg " + kind;
  el.style.display = "block";
  el.innerHTML = `<div class="t">${title}</div><div class="b">${bodyHtml}</div>`;
}
function clearFeedback(){
  $("feedback").style.display = "none";
  $("feedback").className = "msg";
  $("feedback").innerHTML = "";
}

function setWord(w){
  STATE.currentWord = w;
  $("word").textContent = w;
  $("ipa").value = "";
  $("ipa").focus();
  clearFeedback();
  $("sourceLine").textContent = "";
}

function getTargetDialect(){ return $("dialect").value; }

function formatSolution(sol){
  const c = sol?.central ? `[${sol.central}]` : "—";
  const v = sol?.valencian ? `[${sol.valencian}]` : "—";
  return { c, v };
}

function expectedForDialect(sol, dialect){
  if(!sol) return null;
  if(dialect === "valencian") return sol.valencian || sol.central;
  return sol.central;
}

function buildHints(user, exp){
  const hints = [];
  const u = normalizeIPA(user);
  const e = normalizeIPA(exp);

  if(/[ˈˌ]/.test(e) && !/[ˈˌ]/.test(u)) hints.push("T’has deixat la marca d’accent (<span class='monoIPA'>ˈ</span>/<span class='monoIPA'>ˌ</span>).");
  if(e.includes("ə") && !u.includes("ə")) hints.push("Falta <span class='monoIPA'>ə</span> (vocal neutra) — típica en àtones (central/balear).");
  if(e.includes("ɾ") && !u.includes("ɾ") && u.includes("r")) hints.push("Atenció <span class='monoIPA'>ɾ</span> (simple) vs <span class='monoIPA'>r</span> (múltiple).");
  if(e.includes("ʎ") && !u.includes("ʎ")) hints.push("Falta <span class='monoIPA'>ʎ</span> (ll).");
  if(e.includes("ɲ") && !u.includes("ɲ")) hints.push("Falta <span class='monoIPA'>ɲ</span> (ny).");

  const d = simpleDiff(e,u);
  if(d.missing) hints.push(`Falten: <span class="monoIPA">"${d.missing}"</span>`);
  if(d.extra) hints.push(`Sobra: <span class="monoIPA">"${d.extra}"</span>`);

  return [...new Set(hints)].slice(0,6);
}

async function ensureWord(){
  if(STATE.pool.length < 20 && STATE.onlineOk){
    try{ await fetchMoreWords(); }
    catch{ STATE.onlineOk = false; updatePills(); }
  }

  if(STATE.pool.length === 0){
    for(const w of OFFLINE_WORDS) if(!STATE.used.has(w)) STATE.pool.push(w);
    STATE.onlineOk = false;
    updatePills();
  }

  const idx = Math.floor(Math.random()*STATE.pool.length);
  const w = STATE.pool.splice(idx,1)[0];
  STATE.used.add(w);
  saveState();
  updatePills();
  setWord(w);

  STATE.solution = null;
  $("sourceLine").textContent = "";
  if(STATE.onlineOk){
    try{
      STATE.solution = await fetchIPA(w);
      $("sourceLine").textContent = "Solució: " + STATE.solution.source;
    }catch(e){
      showFeedback("warn","No he pogut generar la solució IPA (online)",
        "Error obtenint la solució. Prova <b>Nova paraula</b>." +
        `<div class='smallNote' style='margin-top:6px'>Detall: ${e?.message || e}</div>`
      );
    }
  }else{
    showFeedback("warn","Mode offline (limitacions)","Sense connexió: paraules i solució limitades.");
  }
}

async function newWord(){ await ensureWord(); }

function reveal(){
  if(!STATE.solution){
    showFeedback("warn","Encara no hi ha solució","Prova <b>Nova paraula</b>.");
    return;
  }
  const {c,v} = formatSolution(STATE.solution);
  showFeedback("warn","Solució",
    `<div><b>Central/Balear:</b> <span class="monoIPA">${c}</span></div>` +
    `<div style="margin-top:6px"><b>Valencià:</b> <span class="monoIPA">${v}</span></div>`
  );
}

function check(){
  if(!STATE.currentWord){ showFeedback("warn","No hi ha paraula","Clica <b>Nova paraula</b>."); return; }
  if(!STATE.solution){ showFeedback("warn","No hi ha solució","Prova <b>Nova paraula</b>."); return; }

  const dialect = getTargetDialect();
  const user = $("ipa").value;

  const expCentral = STATE.solution.central || "";
  const expVal = STATE.solution.valencian || "";
  const expTarget = expectedForDialect(STATE.solution, dialect) || "";

  const nu = normalizeIPA(user);
  const neT = normalizeIPA(expTarget);

  if(nu === neT){
    showFeedback("ok","Correcte ✅", `Molt bé! <span class="monoIPA">[${nu}]</span>`);
    return;
  }

  if(dialect === "both"){
    const neC = normalizeIPA(expCentral || "");
    const neV = normalizeIPA(expVal || "");
    if(nu === neC || (neV && nu === neV)){
      showFeedback("ok","Correcte ✅", `Coincideix amb una variant: <span class="monoIPA">[${nu}]</span>`);
      return;
    }
  }

  const {c,v} = formatSolution(STATE.solution);
  const hints = buildHints(user, expTarget);
  const hintHtml = hints.length ? `<ul class="hintList">${hints.map(h=>`<li>${h}</li>`).join("")}</ul>` : "";

  showFeedback("bad","No és exactament igual ❌",
    `<div><b>La teva:</b> <span class="monoIPA">[${normalizeIPA(user)}]</span></div>` +
    `<div style="margin-top:6px"><b>Solució (Central/Balear):</b> <span class="monoIPA">${c}</span></div>` +
    `<div style="margin-top:6px"><b>Solució (Valencià):</b> <span class="monoIPA">${v}</span></div>` +
    (hintHtml ? `<div style="margin-top:10px"><b>Pistes:</b>${hintHtml}</div>` : "")
  );
}

function resetPool(){
  STATE.used = new Set();
  STATE.pool = [];
  STATE.contByCat = {};
  saveState();
  updatePills();
  showFeedback("warn","Pool reiniciat","He esborrat l’historial de paraules usades.");
}

/* ===== Teclat IPA ===== */
const IPA_KEYS = [
  {k:"[", t:"["},{k:"]", t:"]"},{k:".", t:"."},{k:"ˈ", t:"ˈ"},{k:"ˌ", t:"ˌ"},{k:"ː", t:"ː"},
  {k:"‿", t:"‿", small:true},
  {k:"i",t:"i"},{k:"e",t:"e"},{k:"ɛ",t:"ɛ"},{k:"a",t:"a"},{k:"ə",t:"ə"},{k:"ɔ",t:"ɔ"},{k:"o",t:"o"},{k:"u",t:"u"},{k:"y",t:"y"},{k:"ø",t:"ø"},
  {k:"p",t:"p"},{k:"b",t:"b"},{k:"t",t:"t"},{k:"d",t:"d"},{k:"k",t:"k"},{k:"g",t:"g"},
  {k:"β",t:"β"},{k:"ð",t:"ð"},{k:"ɣ",t:"ɣ"},
  {k:"f",t:"f"},{k:"v",t:"v"},{k:"s",t:"s"},{k:"z",t:"z"},{k:"ʃ",t:"ʃ"},{k:"ʒ",t:"ʒ"},
  {k:"x",t:"x"},{k:"ɲ",t:"ɲ"},{k:"ŋ",t:"ŋ"},{k:"ɱ",t:"ɱ"},{k:"m",t:"m"},{k:"n",t:"n"},
  {k:"l",t:"l"},{k:"ʎ",t:"ʎ"},{k:"ɫ",t:"ɫ", small:true},{k:"ɾ",t:"ɾ"},{k:"r",t:"r"},
  {k:"j",t:"j"},{k:"w",t:"w"},
  {k:"t͡s",t:"t͡s", small:true},{k:"d͡z",t:"d͡z", small:true},{k:"t͡ʃ",t:"t͡ʃ", small:true},{k:"d͡ʒ",t:"d͡ʒ", small:true},
  {k:"ʔ",t:"ʔ", small:true},{k:"ʲ",t:"ʲ", small:true},{k:"̃",t:"̃", small:true},
];

function insertAtCursor(input, text){
  const start = input.selectionStart ?? input.value.length;
  const end = input.selectionEnd ?? input.value.length;
  input.value = input.value.slice(0,start) + text + input.value.slice(end);
  const pos = start + text.length;
  input.setSelectionRange(pos,pos);
  input.focus();
}

function buildKeyboard(){
  const host = $("kbd");
  if(!host){
    showFeedback("warn","Error de pàgina",
      "No trobo el contenidor del teclat (<code>#kbd</code>). Assegura't que has pujat aquest <code>index.html</code> i no un altre fitxer.");
    return;
  }
  host.innerHTML = "";
  for(const it of IPA_KEYS){
    const d = document.createElement("div");
    d.className = "key monoIPA" + (it.small ? " small" : "");
    d.textContent = it.k;
    d.addEventListener("click", ()=> insertAtCursor($("ipa"), it.t));
    host.appendChild(d);
  }
}

function wire(){
  $("btnNew").addEventListener("click", newWord);
  $("btnReset").addEventListener("click", resetPool);
  $("btnCheck").addEventListener("click", check);
  $("btnReveal").addEventListener("click", reveal);
  $("btnClear").addEventListener("click", ()=>{ $("ipa").value=""; $("ipa").focus(); });

  $("btnBksp").addEventListener("click", ()=>{
    const inp = $("ipa");
    const start = inp.selectionStart ?? inp.value.length;
    const end = inp.selectionEnd ?? inp.value.length;
    if(start !== end){
      inp.value = inp.value.slice(0,start) + inp.value.slice(end);
      inp.setSelectionRange(start,start);
    } else if(start>0){
      inp.value = inp.value.slice(0,start-1) + inp.value.slice(start);
      inp.setSelectionRange(start-1,start-1);
    }
    inp.focus();
  });

  $("btnSpace").addEventListener("click", ()=> insertAtCursor($("ipa"), " "));
  $("ipa").addEventListener("keydown", (e)=>{ if(e.key === "Enter"){ e.preventDefault(); check(); }});
}

/* ✅ IMPORTANT: esperem que el DOM existeixi (evita #kbd null) */
document.addEventListener("DOMContentLoaded", ()=>{
  loadState();
  buildKeyboard();
  wire();
  updatePills();
  newWord();
});
</script>
</body>
</html>
